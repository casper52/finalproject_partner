<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout1}">

<div layout:fragment="content">

<style scoped>
#speech_box {
	border-radius: 1em;
	padding: 1em;
	padding-right: 4em;
	border: 1px solid #e0e0e0;
	font-size: 14px;
	font-family: '돋움', Dotum, AppleGothic, sans-serif;
	position: relative;
	background: #f9f9f9;
	min-height: 4em
}

#speech_box button {
	position: absolute;
	top: .4em;
	right: .4em;
	border-radius: .4em;
	border: 1px solid #e9e9e9;
	background: #f0f0f0;
	padding: .5em;
	cursor: pointer
}

#speech_box button:hover, #speech_box.on button {
	background: #f5f5f5;
	font-weight: bold
}

#speech_box {
	color: #333
}

#speech_box span {
	display: block
}

#speech_box .text {
	color: #bbb
}
</style>
		
		<div id="conversation">
			<div id="greetings">
			</div>
			<button id="Disconnected">연결종료</button>
		</div>
	
	
	<!-- 지우면 안되는 /div 태그 -->
	</div>


	<!-- Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
		aria-labelledby="MyModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h5>5초간 음성 인식이 시작됩니다. 수행명령을 말하세요.</h5>
				</div>
				<div class="modal-body">
					<div id="speech_box"></div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>

</div>

<th:block layout:fragment="script">
<script th:inline="javascript">
$(document).ready(function () {
	
	var ws; 
	
	$(function () {
	     connect();
    	 console.log("connect complete.....");
	     	 $(function() { sendName(); });
	});	 


	function setConnected(connected) { 
		 $("#Disconnected").prop("disabled", !connected);
		 
		if (connected){
			
			$("#conversation").show();
			$("#greetings").html("");
		}
		else{
			ws.close();
			console.log("Disconnected");
			
		}

	}

	function connect() {
		ws = new WebSocket('ws://localhost:8080/name');
		ws.onmessage = function(data){
			showGreeting(data.data);
		}
		 setConnected(true);
	}
	
 	function disconnect() {
	    if (ws != null) {
	        ws.close();
	    }
	    setConnected(false);
	} 

 	function sendName() {
		var data = JSON.stringify({'myDevice': '00000000089c4f68'})
	    ws.send(data);
	} 


	function showGreeting(message) {
	    	
	    $("#greetings").append("<tr><td> " + message + "</td></tr>");
	    $("#myModal").modal("show");
			
			var tempMsg = "";
			
			 if(!('webkitSpeechRecognition' in window)) $('#myModal').html('<strong>지원하지 않는 브라우저입니다.</strong>');
			 
			  else{
			    var mic = new webkitSpeechRecognition();
			    mic.continuous = true;
			    mic.interimResults = true;
			    mic.lang = 'ko-KR';
			    
			    mic.onresult = function(e) {
			      var b = '', c = false;
			      for(var i = e.resultIndex; i < e.results.length; ++i) {
			        b += e.results[i][0].transcript;
			        c = e.results[i].isFinal;
			      }
			      if($('#speech_box .text').length < 1) $('#speech_box').append('<span class="text"></span>');
			      $('#speech_box .text').text(b);
			      if(c) $('#speech_box .text').removeClass('text');
			      
			      tempMsg = b;
			       
			    };
					 
			    
	    	    <!--마이크 end 일 때-->
	    	    mic.onend = function() {
	    	    	
	    	    console.log(tempMsg);
	  
	    	  	mic.stop();
	    	    $('.modal-body').removeClass('on');


	    	      
	    	    };
	    	    
			    
			    <!--마이크 on 일 때-->
			    $(".modal-body").show(function () {
			      if($('.modal-body').hasClass('on')) mic.stop();
			      else {
			        mic.start();
			        console.log("mic start.............")
			        
			      $('.modal-body').toggleClass('on');
			      window.setTimeout(function () {
			    	  	mic.stop();
				        $("#myModal").modal("hide");
				      $('.modal-body').removeClass('on');
				    },5000);
			      <!-- close else -->
			      }
			     
			    <!-- close function -->
			    });
			      
			      
			  <!-- close else -->
			  }
			 
	};
	
	$(function () {
		 $( "#Disconnected" ).click(function() { disconnect(); });	
	});	
});
</script>
</th:block>

